name: Build ConnectTool
on:
  push:
    branches:
      - "**"
    paths-ignore:
      - "docs/**"
      - "README.md"
      - ".github/ISSUE_TEMPLATE/**"
    tags:
      - "v*"
  workflow_dispatch:
permissions:
  contents: write
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
env:
  BUILD_TYPE: Release
  BOOST_VERSION: "1.84.0"
jobs:
  build:
    runs-on: windows-latest
    name: Build (Windows)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Setup Ninja
        uses: seanmiddleditch/gha-setup-ninja@v3
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.10.1"
          arch: win64_msvc2022_64
          modules: qt5compat qtshadertools
          cache: true
      - name: Download Boost headers
        shell: pwsh
        run: |
          $boostVersion = $env:BOOST_VERSION
          $boostVersionUnderscore = $boostVersion -replace '\.', '_'
          $boostUrl = "https://archives.boost.io/release/$boostVersion/source/boost_${boostVersionUnderscore}.tar.gz"
          $dest = Join-Path $env:GITHUB_WORKSPACE ".cache\\boost"
          New-Item -ItemType Directory -Path $dest -Force | Out-Null
          $archive = Join-Path $dest "boost_${boostVersionUnderscore}.tar.gz"
          Invoke-WebRequest -Uri $boostUrl -OutFile $archive
          tar -xf $archive -C $dest
          $boostRoot = Join-Path $dest "boost_${boostVersionUnderscore}"
          Add-Content -Path $env:GITHUB_ENV -Value "BOOST_ROOT=$boostRoot"
          Add-Content -Path $env:GITHUB_ENV -Value "BOOST_INCLUDEDIR=$boostRoot"
      - name: Download Steamworks SDK
        shell: bash
        run: |
          set -euo pipefail
          SDK_URL="${{ secrets.STEAMWORKS_SDK_URL }}"
          if [[ -z "$SDK_URL" ]]; then
            echo "::error::STEAMWORKS_SDK_URL secret not set"
            exit 1
          fi
          rm -rf steamworks steamworks_temp steamworks_sdk.zip
          curl -fSLo steamworks_sdk.zip "$SDK_URL"
          unzip -q steamworks_sdk.zip -d steamworks_temp
          mkdir -p steamworks
          if [[ -d "steamworks_temp/sdk" ]]; then
            cp -R steamworks_temp/sdk/. steamworks/
          else
            cp -R steamworks_temp/. steamworks/
          fi
          rm -rf steamworks_sdk.zip steamworks_temp
      - name: Verify Steamworks SDK
        shell: pwsh
        run: |
          $header = Join-Path $PWD "steamworks/public/steam/steam_api.h"
          if (-not (Test-Path $header)) {
            throw "Steamworks SDK headers not found at $header"
          }
          $lib = Join-Path $PWD "steamworks/redistributable_bin/win64/steam_api64.dll"
          if (-not (Test-Path $lib)) {
            throw "Steamworks redistributable not found at $lib"
          }
      - name: Configure CMake
        run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DCMAKE_C_COMPILER=cl.exe -DCMAKE_CXX_COMPILER=cl.exe -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded
      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel
      - name: Install
        run: cmake --install build --config ${{ env.BUILD_TYPE }} --prefix "${{ github.workspace }}/install"
      - name: Deploy Qt runtime (Windows)
        shell: pwsh
        run: |
          $dest = Join-Path $env:GITHUB_WORKSPACE 'install'
          $qtCMakeDir = $env:Qt6_DIR
          $candidateBins = @()
          if ($qtCMakeDir) {
            $candidateBins += [IO.Path]::GetFullPath((Join-Path $qtCMakeDir '..\..\..\bin'))
            $candidateBins += [IO.Path]::GetFullPath((Join-Path $qtCMakeDir '..\..\..\..\bin'))
          }
          $candidateBins += $env:PATH.Split([IO.Path]::PathSeparator)
          $windeploy = $null
          foreach ($binDir in $candidateBins) {
            if (-not $binDir) { continue }
            $exe = Join-Path $binDir 'windeployqt.exe'
            if (Test-Path $exe) {
              $windeploy = $exe
              break
            }
          }
          if (-not $windeploy) {
            $cmd = Get-Command windeployqt.exe -ErrorAction SilentlyContinue
            if ($cmd) {
              $windeploy = $cmd.Source
            }
          }
          if (-not $windeploy) {
            throw "Unable to locate windeployqt.exe. Checked Qt6_DIR and PATH."
          }
          $projectDir = (Get-Location).ProviderPath
          & $windeploy --release --force-openssl --dir "$dest\bin" --qmldir "$projectDir\qml" "$dest\bin\connecttool-qt.exe"
      - name: Flatten Windows bundle layout
        shell: bash
        run: |
          set -euo pipefail
          DEST="${{ github.workspace }}/install"
          RUNTIME="$DEST/runtime"
          mkdir -p "$RUNTIME"
          if [[ -d "$DEST/bin" ]]; then
            shopt -s nullglob
            for entry in "$DEST"/bin/*; do
              mv "$entry" "$DEST/"
            done
            rmdir "$DEST/bin"
          fi
          if [[ -d "$DEST/qml" ]]; then
            rm -rf "$RUNTIME/qml"
            mv "$DEST/qml" "$RUNTIME/"
          elif [[ -d "$DEST/lib/qt-6/qml" ]]; then
            mkdir -p "$RUNTIME/qml"
            cp -R "$DEST/lib/qt-6/qml"/. "$RUNTIME/qml/"
          fi
          if [[ -d "$DEST/plugins" ]]; then
            rm -rf "$RUNTIME/plugins"
            mv "$DEST/plugins" "$RUNTIME/"
          elif [[ -d "$DEST/lib/qt-6/plugins" ]]; then
            rm -rf "$RUNTIME/plugins"
            cp -R "$DEST/lib/qt-6/plugins" "$RUNTIME/plugins"
          fi
          shopt -s nullglob
          for dll in "$DEST"/lib/*.dll; do
            mv "$dll" "$DEST/"
          done
          rm -rf "$DEST/lib"
          if [[ -d "$DEST/translations" ]]; then
            rm -rf "$RUNTIME/translations"
            mv "$DEST/translations" "$RUNTIME/"
          elif [[ -d "$RUNTIME/qml/translations" ]]; then
            :
          fi
          cat > "$DEST/qt.conf" <<'EOF'
          [Paths]
          Prefix = .
          Binaries = .
          Libraries = .
          Plugins = runtime/plugins
          QmlImports = runtime/qml
          Translations = runtime/translations
          EOF
      - name: Bundle Wintun runtime (Windows)
        shell: pwsh
        run: |
          $dest = Join-Path $env:GITHUB_WORKSPACE 'install'
          $tmp = Join-Path $env:RUNNER_TEMP 'wintun'
          $zip = Join-Path $env:RUNNER_TEMP 'wintun.zip'
          Invoke-WebRequest -Uri 'https://www.wintun.net/builds/wintun-0.14.1.zip' -OutFile $zip
          Expand-Archive -Path $zip -DestinationPath $tmp -Force
          $dll = Get-ChildItem -Path $tmp -Recurse -Filter 'wintun.dll' | Where-Object { $_.FullName -match 'amd64|x64' } | Select-Object -First 1
          if (-not $dll) {
            throw "wintun.dll not found in downloaded archive"
          }
          Copy-Item $dll.FullName -Destination (Join-Path $dest 'wintun.dll') -Force
      - name: Remove MSVC redistributable installer (Windows)
        shell: bash
        run: |
          set -euo pipefail
          DEST="${{ github.workspace }}/install"
          rm -f "$DEST/vc_redist.x64.exe"
      - name: Package artifact
        id: package
        shell: bash
        run: |
          set -euo pipefail
          ARTIFACT_NAME="connecttool-qt-windows-x86_64"
          DEST="dist/$ARTIFACT_NAME"
          mkdir -p "$DEST"
          cp -R "${{ github.workspace }}/install"/. "$DEST/"
          echo "artifact_dir=$DEST" >> "$GITHUB_OUTPUT"
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: connecttool-qt-windows-x86_64
          path: ${{ steps.package.outputs.artifact_dir }}
          if-no-files-found: error
  build-macos:
    runs-on: macos-15-intel
    name: Build (macOS)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Setup Ninja
        uses: seanmiddleditch/gha-setup-ninja@v3
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.10.1"
          arch: clang_64
          modules: qt5compat qtshadertools
          cache: true
      - name: Download Boost headers
        shell: bash
        run: |
          set -euo pipefail
          BOOST_VERSION_UNDERSCORE="${BOOST_VERSION//./_}"
          BOOST_URL="https://archives.boost.io/release/${BOOST_VERSION}/source/boost_${BOOST_VERSION_UNDERSCORE}.tar.gz"
          DEST="$PWD/.cache/boost"
          mkdir -p "$DEST"
          curl -fSLo "$DEST/boost_${BOOST_VERSION_UNDERSCORE}.tar.gz" "$BOOST_URL"
          tar -xf "$DEST/boost_${BOOST_VERSION_UNDERSCORE}.tar.gz" -C "$DEST"
          BOOST_ROOT="$DEST/boost_${BOOST_VERSION_UNDERSCORE}"
          echo "BOOST_ROOT=$BOOST_ROOT" >> "$GITHUB_ENV"
          echo "BOOST_INCLUDEDIR=$BOOST_ROOT" >> "$GITHUB_ENV"
      - name: Download Steamworks SDK
        shell: bash
        run: |
          set -euo pipefail
          SDK_URL="${{ secrets.STEAMWORKS_SDK_URL }}"
          if [[ -z "$SDK_URL" ]]; then
            echo "::error::STEAMWORKS_SDK_URL secret not set"
            exit 1
          fi
          rm -rf steamworks steamworks_temp steamworks_sdk.zip
          curl -fSLo steamworks_sdk.zip "$SDK_URL"
          unzip -q steamworks_sdk.zip -d steamworks_temp
          mkdir -p steamworks
          if [[ -d "steamworks_temp/sdk" ]]; then
            cp -R steamworks_temp/sdk/. steamworks/
          else
            cp -R steamworks_temp/. steamworks/
          fi
          rm -rf steamworks_sdk.zip steamworks_temp
      - name: Verify Steamworks SDK
        shell: bash
        run: |
          set -euo pipefail
          header="steamworks/public/steam/steam_api.h"
          if [[ ! -f "$header" ]]; then
            echo "::error::Steamworks SDK headers not found at $header"
            exit 1
          fi
          lib="steamworks/redistributable_bin/osx/libsteam_api.dylib"
          if [[ ! -f "$lib" ]]; then
            echo "::error::Steamworks redistributable not found at $lib"
            exit 1
          fi
      - name: Configure CMake
        shell: bash
        run: |
          set -euo pipefail
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE="${{ env.BUILD_TYPE }}" \
            -DCMAKE_PREFIX_PATH="${{ env.Qt6_DIR }}" \
            -DCMAKE_OSX_ARCHITECTURES=x86_64
      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel
      - name: Deploy Qt runtime (macOS)
        shell: bash
        run: |
          set -euo pipefail
          macdeployqt "build/connecttool-qt.app" \
            -qmldir="${{ github.workspace }}/qml" \
            -verbose=2
      - name: Bundle Steamworks dylibs (macOS)
        shell: bash
        run: |
          set -euo pipefail
          app="build/connecttool-qt.app"
          frameworks_dir="$app/Contents/Frameworks"
          sdk_dir="${{ github.workspace }}/steamworks/redistributable_bin/osx"
          if [[ ! -d "$app/Contents" ]]; then
            echo "::error::Missing app bundle at $app"
            exit 1
          fi
          if [[ ! -f "$sdk_dir/libsteam_api.dylib" ]]; then
            echo "::error::Missing Steamworks libsteam_api.dylib in $sdk_dir"
            exit 1
          fi
          mkdir -p "$frameworks_dir"
          cp -f "$sdk_dir/libsteam_api.dylib" "$frameworks_dir/"
          if [[ -f "$sdk_dir/libsteamwebrtc.dylib" ]]; then
            cp -f "$sdk_dir/libsteamwebrtc.dylib" "$frameworks_dir/"
          fi
          bin="$app/Contents/MacOS/connecttool-qt"
          if [[ -x "$app/Contents/MacOS/.connecttool-qt-wrapped" ]]; then
            bin="$app/Contents/MacOS/.connecttool-qt-wrapped"
          fi
          fix_deps() {
            local lib="$1"
            local lib_path="$frameworks_dir/$lib"
            if [[ ! -f "$lib_path" ]]; then
              return
            fi
            install_name_tool -id "@loader_path/../Frameworks/$lib" "$lib_path" || true
            while read -r dep _; do
              if [[ "$dep" == *"$lib" ]]; then
                install_name_tool -change "$dep" "@loader_path/../Frameworks/$lib" "$bin" || true
              fi
            done < <(otool -L "$bin" | tail -n +2)
          }
          fix_deps "libsteam_api.dylib"
          fix_deps "libsteamwebrtc.dylib"
      - name: Create DMG
        shell: bash
        run: |
          set -euo pipefail
          dmg_dir="$(mktemp -d "${RUNNER_TEMP}/connecttool-dmg.XXXXXX")"
          dmg_path="${{ github.workspace }}/dist/connecttool-qt-macos-x86_64.dmg"
          rm -f "$dmg_path"
          mkdir -p "$(dirname "$dmg_path")"
          cp -R "build/connecttool-qt.app" "$dmg_dir/"
          ln -s /Applications "$dmg_dir/Applications"
          hdiutil create \
            -volname "ConnectTool" \
            -srcfolder "$dmg_dir" \
            -ov -format UDZO -fs HFS+ \
            "$dmg_path"
          rm -rf "$dmg_dir"
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: connecttool-qt-macos-x86_64
          path: dist/connecttool-qt-macos-x86_64.dmg
          if-no-files-found: error
  build-appimage:
    runs-on: ubuntu-latest
    name: Build (Linux AppImage)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Install build dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            patchelf \
            libgl1-mesa-dev \
            libxkbcommon-dev \
            libxkbcommon-x11-0 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-render-util0 \
            libxcb-xinerama0 \
            libxcb-xkb1 \
            libxcb-cursor0 \
            libxrender1 \
            libxi6 \
            libfuse2
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.10.1"
          arch: linux_gcc_64
          modules: qt5compat qtshadertools
          aqtsource: "git+https://github.com/miurahr/aqtinstall.git"
          cache: true
      - name: Download Boost headers
        shell: bash
        run: |
          set -euo pipefail
          BOOST_VERSION_UNDERSCORE="${BOOST_VERSION//./_}"
          BOOST_URL="https://archives.boost.io/release/${BOOST_VERSION}/source/boost_${BOOST_VERSION_UNDERSCORE}.tar.gz"
          DEST="$PWD/.cache/boost"
          mkdir -p "$DEST"
          curl -fSLo "$DEST/boost_${BOOST_VERSION_UNDERSCORE}.tar.gz" "$BOOST_URL"
          tar -xf "$DEST/boost_${BOOST_VERSION_UNDERSCORE}.tar.gz" -C "$DEST"
          BOOST_ROOT="$DEST/boost_${BOOST_VERSION_UNDERSCORE}"
          echo "BOOST_ROOT=$BOOST_ROOT" >> "$GITHUB_ENV"
          echo "BOOST_INCLUDEDIR=$BOOST_ROOT" >> "$GITHUB_ENV"
      - name: Download Steamworks SDK
        shell: bash
        run: |
          set -euo pipefail
          SDK_URL="${{ secrets.STEAMWORKS_SDK_URL }}"
          if [[ -z "$SDK_URL" ]]; then
            echo "::error::STEAMWORKS_SDK_URL secret not set"
            exit 1
          fi
          rm -rf steamworks steamworks_temp steamworks_sdk.zip
          curl -fSLo steamworks_sdk.zip "$SDK_URL"
          unzip -q steamworks_sdk.zip -d steamworks_temp
          mkdir -p steamworks
          if [[ -d "steamworks_temp/sdk" ]]; then
            cp -R steamworks_temp/sdk/. steamworks/
          else
            cp -R steamworks_temp/. steamworks/
          fi
          rm -rf steamworks_sdk.zip steamworks_temp
      - name: Verify Steamworks SDK
        shell: bash
        run: |
          set -euo pipefail
          header="steamworks/public/steam/steam_api.h"
          if [[ ! -f "$header" ]]; then
            echo "::error::Steamworks SDK headers not found at $header"
            exit 1
          fi
          lib="steamworks/redistributable_bin/linux64/libsteam_api.so"
          if [[ ! -f "$lib" ]]; then
            echo "::error::Steamworks redistributable not found at $lib"
            exit 1
          fi
      - name: Download linuxdeploy
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.local/bin"
          curl -fSLo "$HOME/.local/bin/linuxdeploy" \
            https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          curl -fSLo "$HOME/.local/bin/linuxdeploy-plugin-qt" \
            https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x "$HOME/.local/bin/linuxdeploy" "$HOME/.local/bin/linuxdeploy-plugin-qt"
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
      - name: Build AppImage
        shell: bash
        env:
          QML_SOURCES_PATHS: ${{ github.workspace }}/qml
        run: |
          set -euo pipefail
          packaging/appimage/build.sh
      - name: Collect AppImage
        id: package
        shell: bash
        run: |
          set -euo pipefail
          appimage=(packaging/appimage/*.AppImage)
          if (( ${#appimage[@]} == 0 )); then
            echo "::error::No AppImage produced in packaging/appimage"
            exit 1
          fi
          mkdir -p dist
          cp "${appimage[0]}" dist/connecttool-qt-linux-x86_64.AppImage
          echo "artifact_path=dist/connecttool-qt-linux-x86_64.AppImage" >> "$GITHUB_OUTPUT"
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: connecttool-qt-linux-x86_64
          path: ${{ steps.package.outputs.artifact_path }}
          if-no-files-found: error
  release:
    name: Publish Release
    needs: [build, build-macos, build-appimage]
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
      - name: Create release archives
        run: |
          set -euo pipefail
          shopt -s nullglob
          for dir in dist/*; do
            if [[ -d "$dir" ]]; then
              dmg_files=("$dir"/*.dmg)
              if (( ${#dmg_files[@]} )); then
                continue
              fi
              appimage_files=("$dir"/*.AppImage)
              if (( ${#appimage_files[@]} )); then
                continue
              fi
              name="$(basename "$dir")"
              cmake -E chdir dist cmake -E tar cf "${name}.zip" --format=zip "$name"
            fi
          done
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: |
            dist/**/*.zip
            dist/**/*.dmg
            dist/**/*.AppImage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
